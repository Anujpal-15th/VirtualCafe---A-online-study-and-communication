{% extends 'base.html' %}

{% block title %}{{ room.name }} - Virtual Cafe{% endblock %}

{% block extra_css %}
<style>
    .member-item {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 8px;
        border-radius: 8px;
        transition: background 0.2s;
    }
    .member-item:hover {
        background: rgba(102, 126, 234, 0.1);
    }
    .member-avatar {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        object-fit: cover;
        border: 2px solid #667eea;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
    }
    .member-name {
        font-weight: 500;
        color: #333;
    }
    body.dark-theme .member-name {
        color: #e0e0e0;
    }
    
    /* Room Code Display Styles */
    .room-code-display {
        display: inline-flex;
        align-items: center;
        gap: 10px;
        background: rgba(102, 126, 234, 0.15);
        padding: 8px 16px;
        border-radius: 8px;
        border: 1px solid rgba(102, 126, 234, 0.4);
        margin: 8px 0;
    }
    
    .room-code-display strong {
        font-size: 1.1rem;
        color: #667eea;
        letter-spacing: 2px;
        font-weight: 700;
    }
    
    .copy-code-btn {
        background: rgba(102, 126, 234, 0.2);
        border: 1px solid rgba(102, 126, 234, 0.4);
        color: #667eea;
        padding: 4px 12px;
        border-radius: 6px;
        cursor: pointer;
        font-size: 0.85rem;
        transition: all 0.3s ease;
        font-weight: 600;
    }
    
    .copy-code-btn:hover {
        background: rgba(102, 126, 234, 0.3);
        border-color: #667eea;
        transform: scale(1.05);
    }
    
    .copy-code-btn.copied {
        background: rgba(46, 213, 115, 0.2);
        border-color: #2ed573;
        color: #2ed573;
    }
    
    body.dark-theme .room-code-display strong {
        color: #a8b7ff;
    }
</style>
{% endblock %}

{% block content %}
<div class="room-container">
    <!-- Room Header -->
    <div class="room-header">
        <div class="room-info">
            <h1>{{ room.name }}</h1>
            <div class="room-code-display">
                ðŸ“‹ Room Code: <strong id="room-code-text">{{ room.room_code }}</strong>
                <button onclick="copyRoomCode()" class="copy-code-btn" id="copy-btn">Copy</button>
            </div>
            <p class="room-description">{{ room.description }}</p>
        </div>
        <div class="members-count">
            <span id="members-count">{{ members_count }}</span> member(s) online
        </div>
    </div>

    <div class="room-content">
        <!-- Left Column: Video Call + Timer -->
        <div class="left-column">
            <!-- Video Call Section -->
            <div class="video-section">
                <h2>Video Call (1-to-1)</h2>
                <div id="video-status" class="video-status">
                    Ready to connect
                </div>
                
                <div class="video-container">
                    <video id="local-video" autoplay muted playsinline></video>
                    <video id="remote-video" autoplay playsinline></video>
                </div>
                
                <div class="video-controls">
                    <button id="start-call-btn" class="btn btn-success">Start Call</button>
                    <button id="end-call-btn" class="btn btn-danger" style="display:none;">End Call</button>
                    <button id="toggle-mic-btn" class="btn btn-secondary" style="display:none;">ðŸŽ¤ Mic</button>
                    <button id="toggle-camera-btn" class="btn btn-secondary" style="display:none;">ðŸ“¹ Camera</button>
                </div>
            </div>

            <!-- Pomodoro Timer Section -->
            <div class="timer-section">
                <h2>Pomodoro Timer</h2>
                <div id="timer-display" class="timer-display">25:00</div>
                
                <div class="timer-presets">
                    <button class="preset-btn" data-minutes="25">25/5</button>
                    <button class="preset-btn" data-minutes="50">50/10</button>
                    <input type="number" id="custom-minutes" placeholder="Custom" min="1" max="120">
                </div>
                
                <div class="timer-controls">
                    <button id="start-timer-btn" class="btn btn-primary">Start</button>
                    <button id="pause-timer-btn" class="btn btn-warning" style="display:none;">Pause</button>
                    <button id="reset-timer-btn" class="btn btn-secondary">Reset</button>
                </div>
            </div>
        </div>

        <!-- Right Column: Chat + Members -->
        <div class="right-column">
            <!-- Members List -->
            <div class="members-section">
                <h3>Members Online</h3>
                <ul id="members-list" class="members-list">
                    {% for membership in active_members %}
                    <li class="member-item">
                        <img src="{{ membership.user.profile.get_avatar_url }}" alt="{{ membership.user.username }}" class="member-avatar">
                        <span class="member-name">{{ membership.user.username }}</span>
                    </li>
                    {% endfor %}
                </ul>
            </div>

            <!-- Chat Section -->
            <div class="chat-section">
                <h3>Chat</h3>
                <div id="chat-messages" class="chat-messages"></div>
                
                <form id="chat-form" class="chat-form">
                    <input type="text" id="chat-input" placeholder="Type a message..." autocomplete="off">
                    <button type="submit" class="btn btn-primary">Send</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Pass data to JavaScript -->
<script>
    const ROOM_CODE = "{{ room.room_code }}";
    const USERNAME = "{{ user.username }}";
    
    // Copy room code to clipboard
    function copyRoomCode() {
        const roomCode = document.getElementById('room-code-text').textContent;
        const copyBtn = document.getElementById('copy-btn');
        
        navigator.clipboard.writeText(roomCode).then(() => {
            // Update button to show success
            copyBtn.textContent = 'Copied!';
            copyBtn.classList.add('copied');
            
            // Reset button after 2 seconds
            setTimeout(() => {
                copyBtn.textContent = 'Copy';
                copyBtn.classList.remove('copied');
            }, 2000);
        }).catch(err => {
            console.error('Failed to copy:', err);
            alert('Failed to copy room code');
        });
    }
</script>
{% endblock %}

{% block extra_js %}
<script src="/static/js/room.js"></script>
{% endblock %}
